{% extends 'base.html' %}
{% load static %}
{% block title %}Room: {{ room_name }}{% endblock %}

    {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/room.css' %}">
{% endblock %}
</head>

<body class="{% block body_class %}bg-black text-white overflow-hidden{% endblock %}">
{% block content %}
    <div class="d-flex vh-100">
        <!-- Video Section -->
        <div id="video-section" class="flex-fill d-flex flex-column position-relative bg-dark bg-gradient">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary border-opacity-25 bg-dark bg-opacity-75 glass-overlay">
                <h5 class="mb-0 text-white"><i class="bi bi-camera-video me-2"></i>{{ room_name }}</h5>
                <div class="text-secondary small fw-bold">
                    <i class="bi bi-people-fill text-primary me-1"></i>
                    <span id="participant-count" class="text-white">0</span> Participants
                </div>
            </div>

            <!-- Video Grid -->
            <div id="video-streams" class="flex-fill p-4 gap-3 overflow-auto">
                <!-- JS will inject video containers here -->
            </div>

            <!-- Control Bar -->
            <div class="p-3 d-flex justify-content-between align-items-center bg-dark border-top border-secondary border-opacity-25">
                <!-- Left controls -->
                <div class="d-flex gap-2">
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="mic-btn" title="Mute/Unmute">
                        <i class="bi bi-mic-fill fs-5"></i>
                    </button>
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="video-btn" title="Start/Stop Video">
                        <i class="bi bi-camera-video-fill fs-5"></i>
                    </button>
                </div>

                <!-- Center controls -->
                <div class="d-flex gap-2">
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="participants-btn" title="Participants">
                        <i class="bi bi-people-fill fs-5"></i>
                    </button>
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="chat-btn" title="Chat">
                        <i class="bi bi-chat-dots-fill fs-5"></i>
                    </button>
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="share-btn" title="Share Screen">
                        <i class="bi bi-display fs-5"></i>
                    </button>
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="reactions-btn" title="Reactions">
                        <i class="bi bi-emoji-smile-fill fs-5"></i>
                    </button>
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="settings-btn" title="Settings" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear-fill fs-5"></i>
                    </button>
                    <button class="btn btn-secondary border-0 control-btn rounded-3 d-flex align-items-center justify-content-center" id="share-link-btn" title="Share Meeting Link">
                        <i class="bi bi-share-fill fs-5"></i>
                    </button>
                </div>

                <!-- Right control -->
                <div>
                    <button class="btn btn-danger control-btn rounded-pill px-4 w-auto fw-bold d-flex align-items-center gap-2" id="end-call-btn" title="Leave Meeting">
                        <i class="bi bi-telephone-fill"></i> <span class="d-none d-md-inline">Leave</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Participants Panel -->
        <aside class="d-none flex-column border-start border-secondary border-opacity-25 bg-dark position-absolute end-0 top-0 bottom-0 z-2 w-300px h-100 shadow-lg" id="participants-panel">
            <div class="p-3 border-bottom border-secondary border-opacity-25 d-flex justify-content-between align-items-center bg-black bg-opacity-25">
                <h6 class="mb-0"><i class="bi bi-people-fill me-2"></i>Participants (<span id="panel-participant-count">0</span>)</h6>
                <button class="btn-close btn-close-white small" id="close-participants"></button>
            </div>
            <div class="flex-fill overflow-auto p-2 custom-scroll" id="participants-list">
                <!-- Participants will be listed here -->
            </div>
        </aside>

        <!-- Chat Sidebar -->
        <aside id="chat-sidebar" class="d-flex flex-column border-start border-secondary border-opacity-25 bg-body-tertiary w-350px">
            <div class="p-3 border-bottom border-secondary border-opacity-25 bg-dark bg-opacity-50">
                <h6 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Chat</h6>
            </div>
            <div id="chat-logs" class="flex-fill overflow-auto p-3 custom-scroll d-flex flex-column gap-3 bg-dark">
                <!-- Chat messages -->
            </div>
            <div class="p-3 border-top border-secondary border-opacity-25 bg-dark bg-opacity-50">
                <div class="input-group">
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="chat-message-input"
                           placeholder="Type a message..." aria-label="Chat message">
                    <button class="btn btn-primary" type="button" id="chat-message-submit">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Reactions Popup -->
    <div class="position-fixed start-50 translate-middle-x d-none gap-2 p-2 rounded-4 glass-overlay border border-secondary shadow-lg z-3" style="bottom: 90px;" id="reactions-popup">
        <button class="btn btn-link text-decoration-none fs-2 p-1" onclick="sendReaction('üëç')">üëç</button>
        <button class="btn btn-link text-decoration-none fs-2 p-1" onclick="sendReaction('üëè')">üëè</button>
        <button class="btn btn-link text-decoration-none fs-2 p-1" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="btn btn-link text-decoration-none fs-2 p-1" onclick="sendReaction('üòÇ')">üòÇ</button>
        <button class="btn btn-link text-decoration-none fs-2 p-1" onclick="sendReaction('üòÆ')">üòÆ</button>
        <button class="btn btn-link text-decoration-none fs-2 p-1" onclick="sendReaction('üéâ')">üéâ</button>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-secondary small">Microphone</label>
                        <select class="form-select bg-black text-white border-secondary" id="mic-select">
                            <option>Default Microphone</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small">Camera</label>
                        <select class="form-select bg-black text-white border-secondary" id="camera-select">
                            <option>Default Camera</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small">Speaker</label>
                        <select class="form-select bg-black text-white border-secondary" id="speaker-select">
                            <option>Default Speaker</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Link Modal -->
    <div class="modal fade" id="shareLinkModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title"><i class="bi bi-share-fill me-2"></i>Share Meeting Link</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="closeShareModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-4">
                    <div class="p-3 rounded-3 border border-primary bg-black bg-opacity-50 mb-3">
                        <label class="form-label text-secondary small mb-1"><i class="bi bi-link-45deg"></i> Meeting Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="meetingShareLink" readonly onclick="this.select()">
                            <button class="btn btn-primary share-copy-btn fw-bold" onclick="copyMeetingLink()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>
                    <p class="text-secondary small mb-0">
                        <i class="bi bi-info-circle me-1"></i> Share this link with others to invite them to the meeting
                    </p>
                </div>
            </div>
        </div>
    </div>

<!-- 1. Embed data in a hidden div -->
<div id="room-config"
     data-app-id="{{ app_id }}"
     data-channel="{{ room_name }}"
     data-username="{{ username }}"
     data-display-name="{{ display_name }}"
     style="display:none;">
</div>

{% endblock %}
    {% block extra_js %}

    <!-- Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.24.2.js"></script>

<!--    <script>-->
<!--    const APP_ID = "{{ app_id }}";-->
<!--    const TOKEN = null;-->
<!--    const CHANNEL = "{{ room_name }}";-->
<!--    const UID = Math.floor(Math.random() * 10000);-->
<!--    const USERNAME = "{{ username }}";-->
<!--    const DISPLAY_NAME = "{{ display_name }}";-->
<!--    let currentDisplayName = DISPLAY_NAME;-->
<!--    </script>-->
    <script src="{% static 'js/room.js' %}" defer></script>

{% endblock %}
